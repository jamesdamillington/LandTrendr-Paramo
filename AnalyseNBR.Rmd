---
title: "LandTrendr-Paramo NBR Analysis"
author: "James Millington"
date: "2020-07-28"
output: 
  github_document:
    toc: true
---

## Aim and Rationale
We want to compare/characterise (pixel-by-pixel) pre-disturbance value (within Paramo) for LandTrendR outputs for 144 different parameters sets and for time window used to create the outputs (full year vs 4 months).

We need this because we will want to filter LandTrendR results by some pre-disturbance value at some point, but we don't know what that value is yet.

We will compare pairs of pixels that have a disturbance in both full year and 4-month windows _in the same year_ (but we can also do summary stats [below] for _all_ pixels).

Ultimately we want to examine boxplots (and summary stats) of pre-disturbance values to compare full vs 4m-month for each pair of 144 images. To do this we likely need a table that contains the following columns:

* parameterSet (1-144)
* pixelid,
* year,
* subset(full vs 4month),
* pre-D,
* Magnitude,
* Duration, DSNR, Rate [if getting these for each pixel doesn't add to much processing time]


## Data 

```{r message=F}
library(raster)
library(sf)

#function to create raster of cellIDs and apply layer names
cidNames <- function(myStack){
  cid <- myStack[[1]]
  cid[] <- seq(1:length(myStack[[1]]))
  myStack <- stack(myStack,cid)

  names(myStack) <- c("Year", "Magnitude", "Duration", "PreValue", "SpecChg", "DSNR","cellID")
  return(myStack)
}

#function to set 0 to NA in raster
NAize <- function(x) { ifelse(x == 0, NA, x) }


#read mask data 
GISpath <- "/home/james/OneDrive/Research/Projects/ColombiaBIO/Fire/Fire GIS Files/" #linux
buf_r <- raster(paste0(GISpath,"500mbufferOfComplejos/GroundTruthingBuffer500m_mask.tif"))
buf_r_trim <- trim(buf_r)

dum <- calc(buf_r_trim,NAize)


crp <- extent(buf_r_trim)

#crop for testing
#crp <- c(620000, 630000, 570000, 580000)

dsubs <- data.frame(a=0,b=NA)

#read crop (for testing)
FY1 <- stack("Data/NBRanalysis/LTR_AllYear_1.tif")
FY1 <- crop(FY1, crp)

#writeRaster(FY1, "Data/NBRanalysis/LTR_AllYear_1_crop.tif")

#cellID, names NAs
FY1 <- cidNames(FY1)
FY1[["Year"]] <- calc(FY1[["Year"]],NAize)
FY1 <- subs(FY1,y=dsubs, by=1, which=2, subsWithNA=F)
plot(FY1)

#read crop (for testing)
TY1 <- stack("Data/NBRanalysis/LTR_JanApr_1.tif")
TY1 <- crop(TY1, crp)
writeRaster(TY1, "Data/NBRanalysis/LTR_JanApr_1_crop.tif")

#cellID, names NAs
TY1 <- cidNames(TY1)
TY1 <- calc(TY1,NAize)
#plot(TY1)

```


```{r}


library(dplyr)

#stack year layers for full vs third (four month) 

#pairYears <- stack(FY1[["Year"]],TY1[["Year"]])
#names(pairYears) <- c("Full", "Third")
#plot(pairYears)

#set true for any pixels that have identical years, otherwise false. 
equalityChk0 <- function(x,y) { 
  ifelse(!is.na(x) & y > !is.na(y), 
         ifelse(x == y, 1, NA),NA)
}
pairBin <- overlay(FY1[["Year"]],TY1[["Year"]], fun=equalityChk0)
pBsum <- cellStats(pairBin, stat="sum") 

#1 if a disurbance is present in both images (per pixel) in ANY year
disturbancePresent <- function(x,y) { 
  ifelse(!is.na(x) & y > !is.na(y), 1, NA)
}
pairDist <- overlay(FY1[["Year"]],TY1[["Year"]], fun=disturbancePresent)
dPsum <- cellStats(pairDist, stat="sum") 



#subset FY1 to cells with identical years
FY1dat <- FY1[!is.na(pairBin[])]

#convert to tibble
FY1tib <- as_tibble(FY1dat)
FY1tib <- mutate(FY1tib, pset=1, subset="FY") 

#subset TY1 to cells with identical years
TY1dat <- TY1[!is.na(pairBin[])]

#convert to tibble
TY1tib <- as_tibble(TY1dat)
TY1tib <- mutate(TY1tib, pset=1, subset="TY") 

#consolidate
AllDat <- bind_rows(FY1tib, TY1tib)

#set factors
library(forcats)
AllDat <- mutate(AllDat, 
            Year = as_factor(Year), 
            subset=as_factor(subset),
            pset=as_factor(pset))

glimpse(AllDat)
summary(AllDat)
```

```{r}
pStack[]

plot(dat)
plot(pairBin)

dat <- pStack[!is.na(pb[])]

pval <- getValues(pStack, 10)

pval <- getValues(pairBin, 10)


FY1m <- mask(FY1[["Magnitude"]], pairBin)

#then mask for other layers
#then boxplot, hist direct from rasters
boxplot(FY1m, maxpixels=500000)

#and use cellStats for max, median, min, sd, etc. 
cellStats(FY1m, stat='mean')
cellStats(FY1[["Year"]], stat='min')
cellStats(FY1[["Year"]], stat='max')
quantile(FY1m)

summary(FY1[["Year"]])

#raster of cell numbers
rc <- pairBin
rc[] <- seq(1:length(pairBin))



ncell(pb)
dat <- pb[!is.na(pb[])]
plot(dat)

YearsBin <- stack(pairBin, rc)

dat <- !is.na(YearsBin)

pyval <- getValues(YearsBin, 10) 


plot(rc)


```





extract pixel id of true values

use pixel id to extract data (write table to file)
